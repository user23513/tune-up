<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="co.up.tune.aprv.approval.mapper.ApprovalMapper">


	<select id="approvalList" resultType="co.up.tune.aprv.vo.AprvVO">
		<if test="aprvSt == '전체' ">
		SELECT '진행' APRV_ST ,APRV_NO, EMP_NO, TTL, DTTM, MOD_YN, ATCH_NO,
		REQ_ST, APRV_AUTH, DEADLINE, IMPTS
		FROM APRV
		WHERE APRV_NO = (SELECT APRV_NO
						FROM APPROVAL
						WHERE APRVR = #{aprvr}
						AND APRV_ST = '진행')
		UNION ALL 
		SELECT '위임', APRV_NO, EMP_NO, TTL, DTTM, MOD_YN, ATCH_NO,
				REQ_ST, APRV_AUTH, DEADLINE, IMPTS
				FROM APRV
				WHERE APRV_NO = (SELECT APRV_NO
								FROM APPROVAL
								WHERE APRVR = (SELECT EMP_NO
												FROM TRUST
												WHERE RPTT = #{aprvr}
												AND SYSDATE	BETWEEN SDT AND EDT)
								AND APRV_ST = '진행')
		UNION ALL 
		SELECT '참조', APRV_NO, EMP_NO, TTL, DTTM, MOD_YN, ATCH_NO,
				REQ_ST, APRV_AUTH, DEADLINE, IMPTS
				FROM APRV
				WHERE APRV_NO = (SELECT APRV_NO
								FROM REFER
								WHERE EMP_NO = #{aprvr})
		UNION ALL 
		SELECT '반려', APRV_NO, EMP_NO, TTL, DTTM, MOD_YN, ATCH_NO,
				REQ_ST, APRV_AUTH, DEADLINE, IMPTS
				FROM APRV
				WHERE APRV_NO = (SELECT APRV_NO
								FROM APPROVAL
								WHERE APRVR = #{aprvr} 
								AND APRV_ST = '반려')
		UNION ALL 
		SELECT '완료', APRV_NO, EMP_NO, TTL, DTTM, MOD_YN, ATCH_NO,
				REQ_ST, APRV_AUTH, DEADLINE, IMPTS
				FROM APRV
				WHERE APRV_NO = (SELECT APRV_NO
								FROM APPROVAL
								WHERE APRVR = #{aprvr}
								AND APRV_ST = '완료')
		ORDER BY APRV_NO DESC								
		</if>
		
		<if test="aprvSt == '진행' ">
		SELECT '진행' APRV_ST ,APRV_NO, EMP_NO, TTL, DTTM, MOD_YN, ATCH_NO,
		REQ_ST, APRV_AUTH, DEADLINE, IMPTS
		FROM APRV
		WHERE APRV_NO = (SELECT APRV_NO
						FROM APPROVAL
						WHERE APRVR = #{aprvr}
						AND APRV_ST = '진행')
		ORDER BY APRV_NO DESC
		</if>
		
		<if test="aprvSt == '위임' ">
		SELECT '위임' APRV_ST ,APRV_NO, EMP_NO, TTL, DTTM, MOD_YN, ATCH_NO,
		REQ_ST, APRV_AUTH, DEADLINE, IMPTS
		FROM APRV
		WHERE APRV_NO = (SELECT APRV_NO
						FROM APPROVAL
						WHERE APRVR = (SELECT EMP_NO
										FROM TRUST
										WHERE RPTT = #{aprvr}
										AND SYSDATE	BETWEEN SDT AND EDT)
						AND APRV_ST = '진행')
		ORDER BY APRV_NO DESC
		</if>
		
		<if test="aprvSt == '참조' ">
		SELECT '참조' APRV_ST ,APRV_NO, EMP_NO, TTL, DTTM, MOD_YN, ATCH_NO,
		REQ_ST, APRV_AUTH, DEADLINE, IMPTS
		FROM APRV
		WHERE APRV_NO = (SELECT APRV_NO
						FROM REFER
						WHERE EMP_NO = #{aprvr})
		ORDER BY APRV_NO DESC	
		</if>
		
		<if test="aprvSt == '반려' ">
		SELECT '반려' APRV_ST ,APRV_NO, EMP_NO, TTL, DTTM, MOD_YN, ATCH_NO,
		REQ_ST, APRV_AUTH, DEADLINE, IMPTS
		FROM APRV
		WHERE APRV_NO = (SELECT APRV_NO
						FROM APPROVAL
						WHERE APRVR = #{aprvr} 
						AND APRV_ST = '반려')
		ORDER BY APRV_NO DESC
		</if>
		
		<if test="aprvSt == '완료' ">
		SELECT '완료' APRV_ST, APRV_NO, EMP_NO, TTL, DTTM, MOD_YN, ATCH_NO,
					REQ_ST, APRV_AUTH, DEADLINE, IMPTS
		FROM APRV
		WHERE APRV_NO  = (SELECT APRV_NO
							FROM APPROVAL
							WHERE APRVR = #{aprvr}
							AND APRV_ST = '완료')		
		ORDER BY APRV_NO DESC
		</if>
		
	</select>

	<select id="aprvalSelect"
		parameterType="co.up.tune.aprv.vo.AprvVO"
		resultType="co.up.tune.aprv.vo.AprvVO">
		SELECT EMP_NO, TTL, DTTM, MOD_YN, CNTN, ATCH_NO,
		REQ_ST, APRV_AUTH, DEADLINE, IMPTS, REJECT
		FROM APRV
		WHERE APRV_NO = #{aprvNo}
	</select>

	<update id="approvalSign"
		parameterType="co.up.tune.aprv.vo.ApprovalVO">
		UPDATE APPROVAL
		<set>
		APRV_DTTM = SYSDATE,
		<if test="sign != null">
		SIGN=#{sign},
		APRV_ST = '완료'
		</if>
		<if test="reject != null">
		REJECT=#{reject},
		APRV_ST = '반려'
		</if>
		</set>
		WHERE APRV_NO = #{aprvNo}
				AND APRVR =	(SELECT EMP_NO
			   				FROM TRUST
			   				WHERE RPTT = #{aprvr})
			  				OR #{aprvr} 
	</update>

	<select id="trustList" parameterType="co.up.tune.aprv.vo.TrustVO" resultType="co.up.tune.aprv.vo.TrustVO">
		SELECT * 
		FROM TRUST
		WHERE EMP_NO = #{empNo}
		ORDER BY EDT DESC
	</select>
	
	<select id="trustCheck" parameterType="co.up.tune.aprv.vo.TrustVO" resultType="co.up.tune.aprv.vo.TrustVO">
		SELECT * 
		FROM TRUST
		WHERE EMP_NO = #{empNo}
		ORDER BY EDT DESC
	</select>
	
	
	<insert id="trustIn" parameterType="co.up.tune.aprv.vo.TrustVO">
		<selectKey keyProperty="trustNo" order="BEFORE" resultType="int">
			SELECT
			CASE WHEN MAX(TRUST_NO) IS NULL THEN 1
			ELSE
			MAX(TRUST_NO) + 1 END AS NO
			FROM TRUST
		</selectKey>
		INSERT INTO TRUST
				(TRUST_NO, APRVR, RPTT, SDT, EDT)
		VALUES
				(#{trustNo}, #{aprvr}, #{rptt}, #{sdt}, #{edt} )
	</insert>
	
	<update id="trustUp" parameterType="co.up.tune.aprv.vo.TrustVO">
		UPDATE TRUST
		<set>
			<if test="rptt != null">RPTT = #{rptt}</if>
			<if test="sdt != null">SDT = #{sdt}</if>
			<if test="edt != null">EDT = #{edt}</if>
		</set>
		WHERE TRUST_NO = #{trustNo}
	</update>
	
	<delete id="trustDel" parameterType="co.up.tune.aprv.vo.TrustVO">
		DELETE FROM TRUST
		WHERE TRUST_NO = #{trustNo}
	</delete>





</mapper>