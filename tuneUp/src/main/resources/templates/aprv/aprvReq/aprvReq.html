<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layout/layout}">
<head>
<meta charset="UTF-8">
<title>전자결재 - 나의 신청</title>
<link rel="stylesheet" type="text/css"
	href="https://cdn.datatables.net/v/bs5/dt-1.12.1/datatables.min.css" />
<script type="text/javascript"
	src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.1.3/js/bootstrap.bundle.min.js"></script>
<script type="text/javascript"
	src="https://cdn.datatables.net/v/bs5/dt-1.12.1/datatables.min.js"></script>
<style>
*:focus {
	outline: 0;
}
</style>
</head>
<body>

	<!-- ======= Main ======= -->
	<main id="main" class="main" layout:fragment="content">

		<script>
		
		//로딩화면
		loadin(); 
		function loadin(load) {
 			LoadingWithMask("/assets/img/load.gif");
  			setTimeout("closeLoadingWithMask()", 500);
		} 
		function LoadingWithMask(gif) {
			let maskHeight = $(document).height();
			let maskWidth  = window.document.body.clientWidth;
  
  			let mask = "<div id='mask' class='row' style='position:absolute; z-index:9000; background-color:#ffffff; text-align:center; display:none; left:0; top:0;'></div>";
  			let loadingImg = "<div id='loadingImg' class='col align-self-center'>";    
 			loadingImg += " <img src='"+ gif + "' style='position: relative; width: 10%; display: block; margin: 0px auto;'/>";
  			loadingImg += "</div>";
  			
  			$('#main').append(mask);
  			$('#mask').css({'width' : maskWidth +20 , 'height': maskHeight +60});
  			$('#mask').append(loadingImg);
  			$('#mask').show();
		}
		function closeLoadingWithMask() {    
			$('#mask').remove();
			$('#mask').empty();
		}	
		
		//로딩후
		$(document).ready(function() {
			//데이터테이블
			$('#aprvTable').DataTable({
				"dom":'lftip',
				"language": {
		   		"search": ""
		 		},
				lengthChange: false,
				ordering: false,
				info: false
			});
			$('#formTable').DataTable({
				"dom":'lftip',
				"language": {
	   			"search": ""
				},
				lengthChange: false,	
				ordering: false,
				info: false	
			});
				
		//새로고침 후 탭 고정
		$('button[data-bs-toggle="tab"]').on("shown.bs.tab", function (e) {
		    let id = $(e.target).attr("data-bs-target");
		    localStorage.setItem('selectedTab', id)
		});
		let selectedTab = localStorage.getItem('selectedTab');
		if ( selectedTab ) {
		    $('[data-bs-target="' + selectedTab + '"]').tab('show');	    
		} else{
			$('[data-bs-target="#aprv-list"]').tab('show');
		}
		
		//에디터
		let plugins = [ "advlist", "autolink", "lists", "link", "image",
						"preview", "searchreplace", "charmap",
						"fullscreen", "insertdatetime",
						"media", "table", "wordcount", "save" ];
		let edit_toolbar = 'formatselect fontselect fontsizeselect |'
							+ ' forecolor backcolor |' + ' charmap |'
							+ ' bold italic underline strikethrough |'
							+ ' alignjustify alignleft aligncenter alignright |'
							+ ' bullist numlist |' + ' table tabledelete |' + ' link image |' + ' insertdatetime |';
		tinymce.init({
				selector : '#cntn',
				height : 500,
				menubar : false,
				plugins : plugins,
				toolbar : edit_toolbar,
				
				image_title : true,
				automatic_uploads : true,
				file_picker_types : 'image',
				file_picker_callback : function(cb, value, meta) {
					let input = document.createElement('input');
					input.setAttribute('type', 'file');
					input.setAttribute('accept', 'image/*');
					input.onchange = function() {
						let file = this.files[0];
						let reader = new FileReader();
						reader.onload = function() {
							let id = 'blobid' + (new Date()).getTime();
							let blobCache = tinymce.activeEditor.editorUpload.blobCache;
							let base64 = reader.result.split(',')[1];
							let blobInfo = blobCache.create(id, file, base64);
							blobCache.add(blobInfo);
							cb(blobInfo.blobUri(), {
								title : file.name
							});
						};
						reader.readAsDataURL(file);
					};
					input.click();
				},
				content_style : 'body { font-family: Helvetica, Arial, sans-serif; font-size:14px }'
			});
		
		reqSelect();
		formSelect();
		reqSt();
		formCat();
		
	});
		
		//상태카테고리 변경
		function reqSt(){
			$("#reqStBtns").on("click", "button", e=>{
				let reqSt = $(e.target).data("st"); 	
				$.ajax({
					url:'reqSt',
					beforeSend:function(xhr){
				 		xhr.setRequestHeader(header,token);  
				    },
				    type:"post",
				    data:{'reqSt':reqSt},
				    dataType:'json',
				    success:function(obj){ 
				    	$("#aprvtb").html("");
				    	$.each (obj, (idx, o)=> {
				    		let tr ="";
				    		tr += `<tr class="list-group-item list-group-item-action">
								<td class="d-flex justify-content-between align-items-start" data-no='${o.aprvNo}'>
										<div class="ms-2 me-auto">
											<div class="fw-bold">${o.ttl}</div>
											<small></small></div>`;
							if(o.reqSt == '전송' || o.reqSt == '검토'){
								tr +=`<span class="badge bg-secondary rounded-pill"
									style="height: 25px">${o.reqSt}</span>`;
							} else {
								tr+= `<span class="badge bg-primary rounded-pill"
									style="height: 25px">${o.reqSt}</span>`;
							}
								tr +=`</td></tr>`;		
							$("#aprvtb").append(tr);
				    });
				    	$(".reqSt.btn-primary").addClass("btn-outline-primary");
				    	$(".reqSt.btn-primary").removeClass("btn-primary");
				    	$(e.target).removeClass("btn-outline-primary");
				    	$(e.target).addClass("btn-primary");	    	
				    }
				})
			});
		}

		function formCat(){
			$("#formCatBtns").on("click", "button", e=>{
				let formCat = $(e.target).data("cat"); 
				$.ajax({
					url:'formCat',
					beforeSend:function(xhr){
				 		xhr.setRequestHeader(header,token);  
				    },
				    type:"post",
				    data:{'formCat':formCat},
				    dataType:'json',
				    success:function(obj){ 
				    	$("#formtb").html("");
				    	$.each (obj, (idx, o)=> {
				    		let tr ="";
				    		tr += `<tr class="list-group-item list-group-item-action">
								<td class="d-flex justify-content-between align-items-start" data-no='${o.formNo}'>
								<div class="ms-2 me-auto">
									<div class="fw-bold" >${o.ttl}</div>
									<small></small></div>`;
							if(o.formCat == '개인'){
								tr +=`<span class="badge bg-primary rounded-pill"
									style="height: 25px">${o.formCat}</span>`;
							} else {
								tr+= `<span class="badge bg-secondary rounded-pill"
									style="height: 25px">${o.formCat}</span>`;
							}
								tr +=`</td></tr>`;		
							$("#formtb").append(tr);											
				    });
				    	$(".formCat.btn-primary").addClass("btn-outline-primary");
				    	$(".formCat.btn-primary").removeClass("btn-primary");
				    	$(e.target).removeClass("btn-outline-primary");
				    	$(e.target).addClass("btn-primary");	    	
				    }
				})
			});
		}
		
		//글상세
		function reqSelect(){
			$("#aprvtb").on("click", "td", e=>{
				let aprvNo = $(e.target).data("no");
				$.ajax({
					url:'reqView',
					beforeSend:function(xhr){
				 		xhr.setRequestHeader(header,token);  
				    },
				    type:"post",
				    data:{'aprvNo':aprvNo},
				    dataType:'json',
				    success:function(obj){    	
				        $("#vttl").html(obj.ttl);
						$("#tnv").html(obj.cntn);
						$("#viewModal").modal('show');
				        }
				    }) 
				})
			}
		
		function formSelect(){
			$("#formtb").on("click", "td", e=>{
				let formNo = $(e.target).data("no"); 
				$.ajax({
					url:'formView',
					beforeSend:function(xhr){
				 		xhr.setRequestHeader(header,token);  
				    },
				    type:"post",
				    data:{'formNo':formNo},
				    dataType:'json',
				    success:function(obj){
				        $("#vttl").html(obj.ttl);
						$("#tnv").html(obj.cntn);
						$("#viewModal").modal('show');
				        }
				    }) 
				})
			}
</script>

		<!-- ======= Section ======= -->
		<section class="section">

			<!-- card -->
			<div class="card">
				<div class="card-body">

					<br>

					<!-- Page Title -->
					<div class="pagetitle">
						<h1>전자결재</h1>
						<nav>
							<ol class="breadcrumb">
								<li class="breadcrumb-item active">나의 신청</li>
								<li class="breadcrumb-item"><a href="approval">나의 승인</a></li>
								<li class="breadcrumb-item" th:if="${session.auth == 'ADMIN'}"><a
									href="aprvAdmin">관리 기능</a></li>
							</ol>
						</nav>
					</div>
					<!-- End Page Title -->

					<!-- Bordered Tabs -->

					<!-- navList -->
					<ul class="nav nav-tabs nav-tabs-bordered" id="bodyTab"
						role="tablist">
						<li class="nav-item" role="presentation">
							<button class="nav-link active" id="aprv-tab"
								data-bs-toggle="tab" data-bs-target="#aprv-list" type="button"
								role="tab" aria-controls="aprv" aria-selected="false">결재상태보기</button>
						</li>
						<li class="nav-item" role="presentation">
							<button class="nav-link" id="form-tab" data-bs-toggle="tab"
								data-bs-target="#form-list" type="button" role="tab"
								aria-controls="form" aria-selected="false">문서작성하기</button>
						</li>
					</ul>
					<!-- End navList -->

					<!-- Bordered Tabs -->
					<div class="tab-content pt-2" id="bodyTabContent">
						<div class="tab-pane fade show active" id="aprv-list"
							role="tabpanel" aria-labelledby="aprv-tab">

							<br>

							<!-- Card with an image on left -->
							<div class="card mb-3">
								<div class="row g-0">
									<div class="col-md-4">
										<img src="assets/img/aprvReq.jpg"
											class="img-fluid rounded-start" alt="..."
											style="width: 350px;">
									</div>
									<div class="col-md-8">
										<div class="card-body">

											<br>

											<h5 class="card-title">결재신청목록</h5>
											<p class="card-text">
												내가 신청한 결재목록입니다. 진행 상태 및 반려 사유를 확인할 수 있습니다. <br> 문서를
												선택하여 상세내용을 확인할 수 있습니다.
											</p>
											<button type="button" id="lineBtn" class="btn btn-primary"
												data-bs-toggle="modal" data-bs-target="#lineModal">
												<i class="ri-restart-line"> 기본 결재라인 변경</i>
											</button>
										</div>
									</div>
								</div>
							</div>
							<!-- End Card with an image on left -->

							<!-- table card -->
							<div class="card">
								<div class="card-body">
									<div class="row">
										<div class="col text-center">

											<br>

											<div class="btn-group" id="reqStBtns" role="group"
												aria-label="Aprv Request List" style="width: 100%;">
												<button type="button" th:each="s:${st}"
													th:if="${s.cdNm == '전체'}" class="btn btn-primary reqSt" th:text="${s.cdNm}"
													th:data-st="${s.cdNm}">전체</button>
												<button type="button" th:each="s:${st}"
													th:unless="${s.cdNm == '전체'}" class="btn btn-outline-primary reqSt" th:text="${s.cdNm}"
													th:data-st="${s.cdNm}">전체</button>
											</div>

										</div>
									</div>

									<br>

									<table id="aprvTable" class="display center"
										style="width: 100%">
										<thead hidden="hidden">
											<tr>
												<th>제목</th>
											</tr>										
										</thead>
										<tbody id="aprvtb" class="list-group">
											<tr th:each="p : ${aprv}"
												class="list-group-item list-group-item-action">
												<td class="d-flex justify-content-between align-items-start" th:data-no="${p.aprvNo}">
														<div class="ms-2 me-auto">
															<div class="fw-bold" th:text="${p.ttl}">제목</div>
															Cras justo odio <small>And some small print.</small>
														</div>
														<span th:if="${p.reqSt == '전송' or p.reqSt =='검토'  }"
															th:text="${p.reqSt}"
															class="badge bg-secondary rounded-pill"
															style="height: 25px"></span> <span
															th:unless="${p.reqSt == '전송' or p.reqSt =='검토'  }"
															th:text="${p.reqSt}"
															class="badge bg-primary rounded-pill"
															style="height: 25px"></span>
												</td>
											</tr>
										</tbody>
									</table>
								</div>
							</div>

							<!-- <div>
								<form id="frm" method="post" action="aprvSelect">
									<input type="hidden" th:name="${_csrf.parameterName}"
										th:value="${_csrf.token}"> <input type="hidden"
										id="aprvNo" name="aprvNo">
								</form>
							</div> -->
						</div>

						<!-- tabs gap -->

						<div class="tab-pane fade" id="form-list" role="tabpanel"
							aria-labelledby="form-tab">

							<br>

							<!-- Card with an image on left -->
							<div class="card mb-3">
								<div class="row g-0">
									<div class="col-md-4">
										<img src="assets/img/aprvForm.jpg"
											class="img-fluid rounded-start" alt="..."
											style="width: 350px;">
									</div>
									<div class="col-md-8">
										<div class="card-body">
											<br>
											<h5 class="card-title">기본서식목록</h5>
											<p class="card-text">결재 서식목록입니다. 서식을 클릭하시면 해당 양식으로 간편하게
												결재문서를 작성할 수 있습니다.</p>
											<button type="button" id="newBtn" class="btn btn-primary">
												<i class="ri-star-fill" data-bs-toggle="modal"
													data-bs-target="#newModal"> 새로운 서식으로 작성</i>
											</button>
										</div>
									</div>
								</div>
							</div>
							<!-- End Card with an image on left -->

							<div class="card">
								<div class="card-body">

									<br>

									<div class="row">
										<div class="col text-center">
											<div class="btn-group" role="group" id="formCatBtns"
												aria-label="Aprv Form List" style="width: 100%">
												<button type="button" th:each="t:${cat}" th:if="${t.cdNm == '전체'}"
													class="btn btn-primary formCat" th:text="${t.cdNm}"
													th:data-cat="${t.cdNm}">전체</button>
												<button type="button" th:each="t:${cat}" th:unless="${t.cdNm == '전체'}"
													class="btn btn-outline-primary formCat" th:text="${t.cdNm}"
													th:data-cat="${t.cdNm}">전체</button>
											</div>
										</div>
									</div>

									<br>

									<table id="formTable" class="display center"
										style="width: 100%">
										<thead hidden="hidden">
											<tr>
												<th>제목</th>
											</tr>										
										</thead>
										<tbody id="formtb" class="list-group">
											<tr th:each="f : ${form}"
												class="list-group-item list-group-item-action">
												<td class="d-flex justify-content-between align-items-start" th:data-no="${f.formNo}">
														<div class="ms-2 me-auto">
															<div class="fw-bold" th:text="${f.ttl}">제목</div>
															Cras justo odio <small>And some small print.</small>
														</div>
														
														<span th:if="${f.formCat == '개인'}" th:text="${f.formCat}"
															class="badge bg-primary rounded-pill"
															style="height: 25px"></span> <span
															th:unless="${f.formCat == '개인'}" th:text="${f.formCat}"
															class="badge bg-secondary rounded-pill"
															style="height: 25px">기타</span>
												</td>
											</tr>
										</tbody>
									</table>
								</div>
								<!-- <div>
									<form id="formfrm" method="post" action="formSelect">
										<input type="hidden" th:name="${_csrf.parameterName}"
											th:value="${_csrf.token}"> <input type="hidden"
											id="formNo" name="formNo">
									</form>
								</div> -->
							</div>
						</div>
					</div>
				</div>
			</div>
			<!-- End Bordered Tabs -->
		</section>
		<!-- ======= End Section ======= -->

		<!-- Vertically centered Modal -->
		<div class="modal fade" id="lineModal" tabindex="-1">
			<div class="modal-dialog modal-dialog-centered">
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="btn-close" data-bs-dismiss="modal"
							aria-label="Close"></button>
					</div>
					<div class="modal-body" id="lCntn">라인</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-secondary"
							data-bs-dismiss="modal">닫기</button>
						<button type="button" class="btn btn-primary">저장</button>
					</div>
				</div>
			</div>
		</div>
		<!-- End Vertically centered Modal-->

		<!-- Scrolling Modal -->
		<div class="modal fade" id="viewModal" tabindex="-1"
			data-bs-backdrop="true">
			<div class="modal-dialog modal-lg">
				<div class="modal-content">
					<div class="modal-header" id="vttl">
						<button type="button" class="btn-close" data-bs-dismiss="modal"
							aria-label="Close"></button>
					</div>
					<div class="modal-body" id="vCntn">
						<div id="tnv" class=".txtA">에디터</div>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-secondary"
							data-bs-dismiss="modal">닫기</button>
						<button type="button" class="btn btn-primary">수정</button>
					</div>
				</div>
			</div>
		</div>
		<!-- End Scrolling Modal-->

		<!-- Scrolling Modal -->
		<div class="modal fade" id="newModal" tabindex="-1"
			data-bs-backdrop="false">
			<div class="modal-dialog modal-lg">
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="btn-close" data-bs-dismiss="modal"
							aria-label="Close"></button>
					</div>
					<div class="modal-body" id="nCntn">
						<form id="frm" method="post" action="aprvInsert"
							enctype="multipart/form-data">
							<input type="hidden" th:name="${_csrf.parameterName}"
								th:value="${_csrf.token}">
							<table class="table">
								<tr>
									<td colspan="5">
										<div class="row mb-3">
											<label for="ttl" class="col-sm-2 col-form-label center"><b>제목</b></label>
											<div class="col-sm-10">
												<input type="text" class="form-control" id="ttl" name="ttl">
											</div>
										</div>
									</td>
								</tr>
								<tr>
									<td colspan="6"><textarea id="cntn" name="cntn"
											class="line"></textarea></td>
								</tr>
								<tr>
									<td colspan="6"><input type="file" id="file" name="file">
									</td>
								</tr>
							</table>

							<div>
								<button type="button" class="btn btn-secondary"
									data-bs-dismiss="modal">닫기</button>
								<span class="right">
									<button type="button" id="save" class="btn btn-primary ">등록</button>
								</span>
							</div>
						</form>
					</div>

				</div>
			</div>
		</div>
		<!-- End Scrolling Modal-->

	</main>
	<!-- End Main -->

</body>
</html>