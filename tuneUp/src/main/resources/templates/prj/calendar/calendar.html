<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" 
	  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	  layout:decorate="~{layout/layout}">
<head>
<meta charset="UTF-8">
<title>Insert title here</title>
<script src="/js/jquery-3.6.1.min.js"></script>
<link href='/fullcalendar-5.11.3/lib/main.css' rel='stylesheet' />
<script src='/fullcalendar-5.11.3/lib/main.js'></script>
<script>
	let schedules = [];
	
	document.addEventListener('DOMContentLoaded', function () {
	  var calendarEl = document.getElementById('calendar');
	
	  //캘린더 리스트
	  fetch('calendarList') // schedules가 db에 있는 모든 리스트
	    .then(function (result) {
	      return result.json();
	    })
	    .then(function (result) {
	      result.forEach(schedule => {
	        let event = {}
	        event.title = schedule.title;
	        event.start = schedule.startDate;
	        event.end = schedule.endDate;
	        schedules.push(event);
	      });
	
	      // 원래 코드 ~ calendar.render();
	      var calendar = new FullCalendar.Calendar(calendarEl, {
	        headerToolbar: {
	          left: 'prev,next today',
	          center: 'title',
	          right: 'dayGridMonth,timeGridWeek,timeGridDay'
	        },
	        initialDate: new Date(), //'2020-09-12',
	        navLinks: true, // can click day/week names to navigate views
	        selectable: true,
	        selectMirror: true,
	        select: function (arg) {
	          var title = prompt('이벤트를 등록하세요:');
	          console.log(title);
	          console.log(arg);
	          if (title) {
	            // DB에 입력처리
	            fetch('calendarInsert', {
	                method: 'post',
	                headers: {
	                  'Content-type': 'application/x-www-form-urlencoded'
	                },
	                body: `cmd=insert&title=${title}&start=${arg.startStr}&end=${arg.endStr}`
	              })
	              .then(result => result.json())
	              .then(result => {
	                console.log(result);
	
	                // 화면에 그려주는 부분
	                calendar.addEvent({
	                  title: title,
	                  start: arg.start,
	                  end: arg.end,
	                  allDay: arg.allDay
	                })
	
	              })
	              .catch(err => console.error(err));
	
	          }
	          calendar.unselect();
	        },
	        eventClick: function (arg) {
	          if (confirm('일정을 삭제하겠습니까?')) {
	            // 삭제
				console.log(arg)
	            fetch('calendarDelete', {
	                method: 'post',
	                headers: {
	                  'Content-type': 'application/x-www-form-urlencoded'
	                },
	                body: `cmd=delete&title=${arg.event.title}`
	              })
	              .then(result => result.json())
	              .then(result => {
	            	  console.log(result);
	            	  if(result.retCode == 'Success'){
	                	  arg.event.remove();
	            	  }
	              })
	              .catch(err => console.log(err))
	            
	          }
	        },
	        editable: true,
	        dayMaxEvents: true, // allow "more" link when too many events
	        events: schedules
	      });
	
	      calendar.render();
	
	      console.log(schedules);
	    }) // schedules => [{},{},{}]
	
	    .catch(function (err) {
	      console.error(err);
	    })
	
	
	}); // document.addEventListener('DOMContentLoaded', function ()
</script>
<style>
    body {
      margin: 40px 10px;
      padding: 0;
      font-family: Arial, Helvetica Neue, Helvetica, sans-serif;
      font-size: 14px;
    }

    #calendar {
      max-width: 1100px;
      margin: 0 auto;
    }
</style>
</head>
<body>
	<main layout:fragment="content">
		<div id='calendar'></div>
	</main>
</body>
</html>