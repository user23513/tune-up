<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layout/layout}">
<head>
<meta charset="UTF-8">
<meta id="_csrf" name="_csrf" th:content="${_csrf.token}"/>
<meta id="_csrf_header" name="_csrf_header" th:content="${_csrf.headerName}"/>
<title>내프로젝트</title>
<script src="/js/jquery-3.6.1.min.js"></script>
<script src="https://www.gstatic.com/charts/loader.js"></script>
<script>
google.charts.load('current', {'packages':['gantt']});
google.charts.setOnLoadCallback(drawChart);

function drawChart() {
	var data = new google.visualization.DataTable();//아작스 디비 받아와서 
	data.addColumn('string', 'Task ID');
	data.addColumn('string', 'Task Name');
	data.addColumn('string', 'Resource');
	data.addColumn('date', 'Start Date');
	data.addColumn('date', 'End Date');
	data.addColumn('number', 'Duration');
	data.addColumn('number', 'Percent Complete');
	data.addColumn('string', 'Dependencies');

function drawChart(){
	var jsonData = $.ajax({
		url:"/chart/chart02_money",
		dataType:"json",
		async:false
	}).responseText;
  		
   var data = data.addRows(jsonData);
   var chart = new google.visualization.ColumnChart(document.getElementById("chart_div"));

	var options = {
	  height: 400,
	  gantt: {
	    trackHeight: 30
	  }
	};
	//그려주는 부분 div안에 넣어줌
    var chart = new google.visualization.Gantt(document.getElementById('chart_div'));

    chart.draw(data, options);
  }
 }
</script>
<script th:inline="javascript">
$(document).ready(function() {
	var token = $("meta[name='_csrf']").attr("content");
	var header = $("meta[name='_csrf_header']").attr("content");
	
	//==============댓글==============
	
	//댓글 등록 버튼 클릭시
	$("#rBtn").on("click", e=>{
		let postNo = $("#postNo").val(); //게시글 번호
		let postTitle = $("#postTitle").val(); //게시글 제목
		let cntn = $("#rCntn").val();    //댓글 내용
		let empNo = $("#empNo").val();   //댓글 쓴 사원번호
		let wrtr = $("#wrtr").val();     //댓글 쓴 사원이름
		let rList = $("<div>").attr("id", "rList"); 
		
		//댓글 등록 처리
		$.ajax({
	         url:'ppReplyInsert',
	         beforeSend:function(xhr){
	 	  		xhr.setRequestHeader(header,token);  
	     	  },
	         type:'post',
	         data:{'postNo':postNo, 'cntn':cntn, 'empNo':empNo, 'wrtr':wrtr},
	         dataType:'json',
	         success:function(res){
					let div = $("<div>").append($("<span>").html(res.wrtr)).append("\u00A0\u00A0")
										.append($("<span>").html(res.dttm))
										.append($("<br>"))
										.append($("<span>").html(res.cntn)).append("\u00A0\u00A0\u00A0")
										.append($("<span>").append($("<i>").addClass("ri-edit-2-line update").attr("data-no", res.replyNo)).append("\u00A0\u00A0\u00A0"))
										.append($("<span>").append($("<i>").addClass("ri-delete-bin-line delete").attr("data-no", res.replyNo)))
										.append($("<hr>"))
					$("#rList").prepend(div);
					
					$("#rCntn").val("");
			 
	         }
	    })
	})
})
</script>
<style>
.pagination {
	margin-left: 300px;
}
#ddbt {
	color: gray;
}
</style>
</head>
<body>
<main id="main" class="main" layout:fragment="content">
	<section class="section">
		<div class="card">
			<div class="card-body">
				<h5 class="card-title">MY PROJECT</h5>
				<div class="pagetitle">
					<!-- 관리자 메뉴 -->
					<div style="display: inline-block; margin: 0 5px; float: right;">
						<form action="teamList" method="post">
							<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
							<input type="hidden" id="prjNo" name="prjNo" th:value="${prjNo}">
							<button type="submit" class="btn btn-outline-primary">관리</button>
						</form>
					</div>
					<div style="display: inline-block; margin: 0 5px; float: right;">
						<form action="postInsertForm" method="post">
							<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
							<!-- 프로젝트 번호  -->
							<input type="hidden" id="prjNo" name="prjNo" th:value="${prjNo}">
							<button type="submit" class="btn btn-outline-primary">글쓰기</button>
						</form>
					</div>
					
					<br>
					<br>
				</div>
				<!-- Default Tabs -->
				<ul class="nav nav-tabs d-flex" id="myTabjustified" role="tablist">
					<li class="nav-item flex-fill" role="presentation">
						<button class="nav-link w-100 active" id="home-tab"
							data-bs-toggle="tab" data-bs-target="#home-justified"
							type="button" role="tab" aria-controls="home"
							aria-selected="false">Home</button>
					</li>
					<li class="nav-item flex-fill" role="presentation">
						<button class="nav-link w-100" id="pst-tab" data-bs-toggle="tab"
							data-bs-target="#pst" type="button" role="tab"
							aria-controls="pst" aria-selected="true">글</button>
					</li>
					<li class="nav-item flex-fill" role="presentation">
						<button class="nav-link w-100" id="contact-tab"
							data-bs-toggle="tab" data-bs-target="#contact-justified"
							type="button" role="tab" aria-controls="contact"
							aria-selected="false">업무</button>
					</li>
					<li class="nav-item flex-fill" role="presentation">
						<button class="nav-link w-100" id="schedule-tab"
							data-bs-toggle="tab" data-bs-target="#schedule"
							type="button" role="tab" aria-controls="contact"
							aria-selected="false">일정</button>
					</li>
					<li class="nav-item flex-fill" role="presentation">
						<button class="nav-link w-100" id="contact-tab"
							data-bs-toggle="tab" data-bs-target="#contact-justified"
							type="button" role="tab" aria-controls="contact"
							aria-selected="false">할 일</button>
					</li>
				</ul>
				<div class="tab-content pt-2" id="myTabjustifiedContent">
					<div class="tab-pane fade show active" id="home-justified"
						role="tabpanel" aria-labelledby="home-tab">
						<div id="chart_div">
						</div>	
					</div>	
				
				<!-- Start 일정 목록 -->
				<div class="tab-pane fade" id="schedule" role="tabpanel" aria-labelledby="schedule-tab">
					<div class="card" style="width: 80%; position: relative; left: 150px; margin-top: 50px;" th:each="s,idx : ${scheduleList}">
						<div class="card-body">
							<div class="card-title">
								<span>[[${s.wrtr}]]</span>
								<!-- 드롭다운 아이콘 -->
								<div class="filter" style="float: right" >
									<a class="icon" href="#" data-bs-toggle="dropdown">
										<i class="bi bi-three-dots" ></i>
									</a>
									<!-- 드롭다운 수정삭제 펼치기 -->
									<ul class="dropdown-menu dropdown-menu-end dropdown-menu-arrow" >
										<li class="dropdown-header text-start" > Settings
											<button class="dropdown-item" style="text-align: center">수정</button>
											<button class="dropdown-item" style="text-align: center">삭제</button>
										</li>	
									</ul>
								</div>
							</div>
							<span style="font-size: large;">[[${s.ttl}]]</span><br>
							<span>[[${s.sdt}]] - [[${s.edt}]]</span><hr style="color: gray;">
							<div>
								<span th:each="m : ${scheduleMember}" th:if="${s.postNo}==${m.postNo}">[[${m.nm}]]&nbsp;</span><br>
								<span th:id="${idx.count}"></span>
								<div class="map" style="width:700px; height:300px;"></div><br>
							</div>
							<div>
								<button type="button">참석</button>
								<button type="button">불참</button>
								<button type="button">미정</button>
							</div>
							<br>
							<div class="form-floating mb-3">
								<textarea class="form-control" placeholder="Leave a comment here"
										  style="height: 100px; resize: none"></textarea>
								<label for="floatingTextarea">Comments</label>
							</div>
							<button class="btn btn-primary btn-sm" style="float: right" type="button">등록</button>
						</div>
					</div>
				</div>
				<!-- End 일정 목록 -->
				
				<!-- 글 목록 -->
				<div class="tab-pane fade" id="pst" role="tabpanel" aria-labelledby="pst-tab">
					<!-- Default Card -->
					<div>
						<input type="hidden" id="empNo" name="empNo" th:value="${session.empNo}">
						<input type="hidden" id="wrtr" name="wrtr" th:value="${session.nm}">
						<div class="card" style="width: 80%; position: relative; left: 150px; margin-top: 50px;" th:each="p :${postList}">
							<div class="card-body">
								<div class="card-title">
									<span th:text="${p.wrtr}"></span>
									<span th:text="${#dates.format(p.dttm, 'yyyy-MM-dd')}"></span>
									<!-- 드롭다운 아이콘 -->
									<div class="filter" style="float: right" >
										<a class="icon" href="#" data-bs-toggle="dropdown">
											<i class="bi bi-three-dots" ></i>
										</a>
										<!-- 드롭다운 수정삭제 펼치기 -->
										<ul class="dropdown-menu dropdown-menu-end dropdown-menu-arrow" >
											<li class="dropdown-header text-start" > Settings</li>
											<form id="upFrm" action="postUpdateForm" method="post" >
												<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
												<input type="hidden" id="postNo" name="postNo" th:value="${p.postNo}">
												<button id="up" class="dropdown-item" style="text-align: center">수정</button>
											</form>
											<form id="delFrm" action="prjPostDelete" method="post" >
												<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
												<input type="hidden" id="postNo" name="postNo" th:value="${p.postNo}">
												<button id="delete" class="dropdown-item" style="text-align: center">삭제</button>
											</form>
										</ul>
									</div>
								</div>
								<span style="font-size: large;"><h3>[[${p.ttl}]]</h3></span>
								<hr>
								<div th:text="${p.cntn}" style="font-size: medium; min-height: 200px;"></div>
								<br><br>
								첨부파일:<span th:text="${p.atchNo}" style="font-size: large;"> </span><br><br>
								<div id="rList">
									<div th:each="r : ${ppReplyList}">
										<span th:text="${r.wrtr}">작성자</span>&nbsp;
										<span th:text="${r.cntn}">댓글내용</span>&nbsp;&nbsp;
										<br>
										<!-- 수정아이콘 -->
										<span>
											<i class="ri-edit-2-line update" th:attr="data-no=${r.replyNo}" th:if="${session.empNo == pj.empNo}"></i>
										</span>&nbsp;
										<!-- 삭제아이콘 --> 
										<span>
											<i class="ri-delete-bin-line delete" th:attr="data-no=${r.replyNo}" th:if="${session.empNo == pj.empNo}"></i>
										</span> 
										<hr>
									</div>
								</div>
								<div class="form-floating mb-3">
									<textarea class="form-control" placeholder="Leave a comment here" id="rCntn" 
											  style="height: 100px; resize: none"></textarea>
									<label for="floatingTextarea">Comments</label>
								</div>
								<form id="rupFrm" action="ppReplyInsert" method="post">
									<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
									<button id="rBtn" class="btn btn-primary btn-sm" style="float: right" type="button">등록</button>
								</form>	
								<!-- end 댓글 -->
							</div>
						</div>
						<!-- End Default Card -->

						<!-- 페이징 -->
						<nav aria-label="Page navigation example">
							<ul class="pagination">
								<li class="page-item">
									<a class="page-link" href="#" aria-label="Previous"> 
										<span aria-hidden="true">&laquo;</span>
									</a>
								</li>
								<li class="page-item">
									<a class="page-link" href="#">1</a>
								</li>
								<li class="page-item">
									<a class="page-link" href="#">2</a>
								</li>
								<li class="page-item">
									<a class="page-link" href="#">3</a>
								</li>
								<li class="page-item">
									<a class="page-link" href="#" aria-label="Next">
										<span aria-hidden="true">&raquo;</span>
									</a>
								</li>
							</ul>
						</nav>
					</div>
				</div>
			</div>
			</div>
		</div>
	</section>
	
	<!-- 지도 -->
	<script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=8979f5b92eaf5997a6ea3ade6a7e65f1&libraries=services"></script>
	<script th:inline="javascript">
	$("#schedule-tab").on("click", e=>{
		var mapContainers = document.getElementsByClassName('map'), //지도를 표시할 div 배열
		    mapOption = { 
		        center: new kakao.maps.LatLng(33.450701, 126.570667), // 지도의 중심좌표
		        level: 4 // 지도의 확대 레벨
		    };
		
		$.each([[${scheduleList}]], (idx, s)=>{ 
			// 지도를 생성합니다  
			var map = new kakao.maps.Map(mapContainers[idx], mapOption);
			
			// 주소-좌표 변환 객체를 생성합니다
			var geocoder = new kakao.maps.services.Geocoder();
			
			
			getAddr(s.latitude, s.longitude, idx);
			console.log("ee")

			// 마커가 표시될 위치입니다 
			var markerPosition  = new kakao.maps.LatLng(s.latitude, s.longitude); 
			
			// 마커를 생성합니다
			var marker = new kakao.maps.Marker({
			    position: markerPosition
			});
			
			// 마커가 지도 위에 표시되도록 설정합니다
			marker.setMap(map);
			
			var iwContent = '<div style="padding:5px;">여기로 와주세요!!</div>', // 인포윈도우에 표출될 내용으로 HTML 문자열이나 document element가 가능합니다
			    iwPosition = new kakao.maps.LatLng(s.latitude, s.longitude); //인포윈도우 표시 위치입니다
			
			// 인포윈도우를 생성합니다
			var infowindow = new kakao.maps.InfoWindow({
			    position : iwPosition, 
			    content : iwContent 
			});
			  
			// 마커 위에 인포윈도우를 표시합니다. 두번째 파라미터인 marker를 넣어주지 않으면 지도 위에 표시됩니다
			infowindow.open(map, marker);
		})
	})
	
	function getAddr(lat, lng, idx){
	    let geocoder = new kakao.maps.services.Geocoder();

	    let coord = new kakao.maps.LatLng(lat, lng);
	    let callback = function callback(result, status) {
	        if (status === kakao.maps.services.Status.OK) {
	        	console.log(result)
	           	let addressName = result[0].road_address.address_name; //도로명 주소
	            $('#'+ (idx+1)).append(addressName); //주소 넣을 span
	            $('#'+ (idx+1)).append('&nbsp;&nbsp;<a href="https://map.kakao.com/link/map/'+addressName+','+lat+','+lng+'" style="color:blue" target="_blank">지도보기</a>');
	        }
	    };
	    geocoder.coord2Address(coord.getLng(), coord.getLat(), callback);
	}
	
	</script>
	<!-- 지도 -->
	
	<script>
	/* 일정 리스트 */
	/* $("#schedule-tab").on("click", e=>{
		let prjNo = $("#prjNo").val();
		$.ajax({
			url: 'scheduleList',
			beforeSend:function(xhr){
	 	  		xhr.setRequestHeader(header,token);  
	     	},
	     	type: 'post',
	     	data: {'prjNo':prjNo},
	     	dataType: 'json',
	     	success: function(res){
	     		console.log(res);
	     	}
		})
	}) */
	
	/* $(document).ready(function() {
	$("#delete").on("click", e=>{
		$("#delFrm").submit();
	});
	
	//수정버튼
	$("#up").on("click", e=>{
		$("#upFrm").submit();
	});
	
	$("rup").on("click", e=>{
		$("rupFrm").submit();
	});

	})
    } */
 /*    $(document).ready(function() {
		var token = $("meta[name='_csrf']").attr("content");
		var header = $("meta[name='_csrf_header']").attr("content");
    $("#rBtn").on("click", e=>{
		let postNo = $("#postNo").val(); //게시글 번호
		let cntn = $("#rCntn").val();    //댓글 내용
		let empNo = $("#empNo").val();   //댓글 쓴 사원번호
		let wrtr = $("#wrtr").val();     //댓글 쓴 사원이름
		let rList = $("<div>").attr("id", "rList"); 
		
		//댓글 등록 처리
		$.ajax({
	         url:'ppReplyInsert',
	         beforeSend:function(xhr){
	 	  		xhr.setRequestHeader(header,token);  
	     	  },
	         type:'post',
	         data:{'postNo':postNo, 'cntn':cntn, 'empNo':empNo, 'wrtr':wrtr},
	         dataType:'json',
	         success:function(res){
					let div = $("<div>").append($("<span>").html(res.wrtr)).append("\u00A0\u00A0")
										.append($("<span>").html(res.dttm))
										.append($("<br>"))
										.append($("<span>").html(res.cntn)).append("\u00A0\u00A0\u00A0")
										.append($("<span>").append($("<i>").addClass("ri-edit-2-line update").attr("data-no", res.replyNo)).append("\u00A0\u00A0\u00A0"))
										.append($("<span>").append($("<i>").addClass("ri-delete-bin-line delete").attr("data-no", res.replyNo)))
										.append($("<hr>"))
					$("#rList").prepend(div);
					
					$("#rCntn").val("");
	         }
	      })
    })
    }) */
	</script>
</main>
</body>

</html>