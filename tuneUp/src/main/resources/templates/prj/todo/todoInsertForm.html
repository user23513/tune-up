<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	  layout:decorate="~{layout/layout}">
<head>
<meta charset="UTF-8">
<meta id="_csrf" name="_csrf" th:content="${_csrf.token}"/>
<meta id="_csrf_header" name="_csrf_header" th:content="${_csrf.headerName}"/>
<title>프로젝트 글쓰기</title>
<style>
input:focus,
input.none
{
	border: none !important;
	display: inline-block;
	border-bottom: 1px solid #d9d9d9 !important;
}

</style>
<script src="/js/jquery-3.6.1.min.js"></script>
<script type="text/javascript">
$(document).ready(function() {
	var token = $("meta[name='_csrf']").attr("content");
	var header = $("meta[name='_csrf_header']").attr("content");
	let i = 0;
	//창 시작시 demoDelete 실행
 	let empNo = $("#empNo").val();
	console.log("empNo : " + empNo);
	$.ajax({
        url: "demoDeleteAll",
        beforeSend:function(xhr){
	  		xhr.setRequestHeader(header,token);  
    	  },
    	 type : "post",
        data:{"empNo" : empNo },
        success:function(res){
        	console.log("DB 삭제 완")
        }
	})
	
	//할일 추가 버튼
	$("#addTodo").on("click", e=>{
		let cntn = $("#todoAdd").val(); //할일
		console.log(cntn);
		i++
		if(cntn == ""){
			alert("할 일을 입력해주세요")
		}else{
			//todo 추가
			$.ajax({
		         url: "demoInsert",
		         beforeSend:function(xhr){
		 	  		xhr.setRequestHeader(header,token);  
		     	  },
		     	 type : "post",
		         data:{"cntn" : cntn , "empNo" : empNo},
		         success:function(res){
		        	 console.log(res);
		        	let str = "<tr><td name='no' class='no' style='display: none'>"+ res.no +"</td>";
		     		str += "<td><input type='hidden' name='cntn' class='cntn' value='"+ res.cntn+"'>"+ res.cntn +"</td><td><button name='remove' type='button' class='btn btn-outline-danger btn-sm' href='javascript:void(0);' style='right: auto;'>";
		     		str += "<i class='bi bi-x-lg'></i></button> </td> </tr>";
		     		$("#tbd").append(str);
		         }
			})
		}
	})

	//todo 삭제버튼 클릭 시 
	$("#tbd").on("click","[name='remove']", e=>{
		console.log("test")
		let no = e.target.closest('tr').firstChild.innerText;
		console.log(no);
		
		//todo 삭제
		$.ajax({
			url: "demoDelete",
			beforeSend:function(xhr){
				xhr.setRequestHeader(header,token);  
			},
			type : "post",
			data:{"no" : no },
			success:function(res){
				console.log(res);
				e.target.closest('tr').remove();
			}
		})
	})
	
	//todo 등록
/* 	$("#test").on("click", e=>{
		console.log("test");
		let cntn1 = $("[name='remove']").val().innerText;
		console.log("cntn = "+cntn1);
		//$("#todoFrm").submit();
	}) */
});

function save(){
/* 	let todo = document.querySelectorAll("tr");
	console.log("test");
 	let cntn1 = $("[name='cntn']").value;
	console.log("cntn = "+cntn1);
	list = [todo.length];
	console.log(list); */
	
/* 	 for(r= 0; r < todo.length; r++){
		let todoNo = todo[r].children[0].innerText;
		console.log("todoNo = " + todoNo);
		let cntn = todo[r].children[1].innerText;
		console.log("cntn = " +cntn);
		list[r] = cntn;
	 }
	 console.log(list); */
/* 	 $.ajax({
	      url: "todoInsert",
	      beforeSend:function(xhr){
		  		xhr.setRequestHeader(header,token);  
	  	  },
	  	  type : "post",
	  	  traditional : true,
	      data:{"ttl" : ttl , "wrtr" : wrtr , "empNo" : empNo, "prjNo" : prjNo, list : JSON.stringify(list)},
	      success:function(res){
	     	 console.log(res);
	     	 console.log("detailIsnert 성공");
	      },
	      error:function(error){
	    	  console.log(error);
	    	  console.log("detailIsnert 실패");
	    	  console.log("ajax cntn = " +cntn);
	    	  console.log("ajax postNo = " +postNo);
	      }
		}) */
	 
	$("#todoFrm").submit();
}

/* function save(){
	var token = $("meta[name='_csrf']").attr("content");
	var header = $("meta[name='_csrf_header']").attr("content");
	let todo = document.querySelectorAll("tr");
	console.log(todo);
	
	let ttl = $("#ttl").val();
	let empNo = $("#empNo").val();
	let wrtr = $("#wrtr").val();
	let prjNo = $("#prjNo").val();
	
	if(todo == null){
		console.log("할일 목록 없음");
		alert("할 일을 등록해주세요");
	}else{
		console.log("할일 있음");
		console.log(todo.length);
		//$("#todoFrm").submit();
		
		//todo insert 시작
 		$.ajax({
	         url: "todoInsert",
	         beforeSend:function(xhr){
	 	  		xhr.setRequestHeader(header,token);  
	     	  },
	     	 type : "post",
	     	 async: false,
	         data:{"ttl" : ttl , "wrtr" : wrtr , "empNo" : empNo, "prjNo" : prjNo },
	         success:function(res){
	        	 console.log(res);
	        	 console.log("todoInsert 성공");
	        	 let postNo = res.postNo;
	        	 console.log("res.postNo = " + postNo);
	        	 
	        	 //detail insert for문 시작
	        	 for(r= 0; r < todo.length; r++){
	     			 let todoNo = todo[r].children[0].innerText;
	     			console.log("todoNo = " + todoNo); 
	     			let cntn = todo[r].children[1].innerText;
	     			console.log("cntn = " +cntn);
	     			
	     			//ajax 시작
	     			$.ajax({
				      url: "detailInsert",
				      beforeSend:function(xhr){
					  		xhr.setRequestHeader(header,token);  
				  	  },
				  	  type : "post",
				      data:{"cntn" : cntn , "postNo" : postNo },
				      async: false,
				      success:function(res){
				     	 console.log(res);
				     	 console.log("detailIsnert 성공");
				      },
				      error:function(error){
				    	  console.log(error);
				    	  console.log("detailIsnert 실패");
				    	  console.log("ajax cntn = " +cntn);
				    	  console.log("ajax postNo = " +postNo);
				      }
					})
					//ajax 끝
	     		}
	        	//for문 끝
	         }
		}) 
		//todo insert 끝
	}
} */
</script>
</head>
<body>
<main layout:fragment="content">
	<div class="card">
		<div class="card-body">
			<h5 class="card-title">PROJECT</h5>
			<!-- Default Tabs -->
			<div style="padding: 20px;">
				<div>
					<ul class="nav nav-tabs d-flex" id="myTabjustified" role="tablist">
						<li class="nav-item flex-fill" role="presentation">
							<button class="nav-link w-100" id="contact-tab"
								data-bs-toggle="tab" data-bs-target="#contact-justified"
								type="button" role="tab" aria-controls="contact"
								aria-selected="false">할일</button>
						</li>
					</ul>
				</div>
				<div class="tab-content pt-2" id="myTabjustifiedContent">
					<div class="tab-content pt-2" id="myTabjustifiedContent">
				
						<!-- 할일 -->
						<form id="todoFrm" action="todoInsert" method="post">
						<div class="tab-pane fade" id="contact-justified" role="tabpanel">
							<div class="row mb-3">
								<!-- todo insert -->
									<div class="col-sm-10" style="width: 80%">
										<input type="text" class="form-control none" style="border-bottom:1px solid blue;"
											id="ttl" name="ttl" placeholder="제목을 입력하세요.">
									</div>
									<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
									<input type="hidden" id="empNo" name="empNo" th:value="${session.empNo}">
									<input type="hidden" id="wrtr" name="wrtr" th:value="${session.nm}">
									<input type="hidden" id="prjNo" name="prjNo" th:value="9">
							</div> <br>
							
							<!-- todo 상세 Insert -->
								<div class="col-sm-10">
									<div class="input-group mb-3">
										<input type="text" id="todoAdd" name="todoAdd" class="form-control" placeholder="할 일 입력" 
										aria-label="Recipient's username" aria-describedby="basic-addon2">
										<button id="addTodo" type="button" class="btn btn-outline-secondary" style="right: auto;">
											<i class="bi bi-plus-lg"></i>
										</button>
									</div>
									<hr>
									<div>
										<table class="table table-borderless">
											<tbody id="tbd">
											</tbody>
										</table>
									</div>
								</div>
								<!-- todo 상세 Insert 끝 -->
							<br>
							<div class="col-md-8 col-lg-9">
				               <button id="btn" class="btn btn-primary" type="button">등록</button>
				               <button id="test" class="btn btn-primary" type="button" onclick="save()">테스트</button>
							</div>
						<!-- 할일 -->
						</div>
						</form>
					<!-- End Default Tabs -->
					</div>
				</div>
			</div>
		</div>
	</div>
</main>
</body>
</html>