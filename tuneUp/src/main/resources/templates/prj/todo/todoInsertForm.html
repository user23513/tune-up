<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	  layout:decorate="~{layout/layout}">
<head>
<meta charset="UTF-8">
<meta id="_csrf" name="_csrf" th:content="${_csrf.token}"/>
<meta id="_csrf_header" name="_csrf_header" th:content="${_csrf.headerName}"/>
<title>프로젝트 글쓰기</title>
<style>
input:focus,
input.none
{
	border: none !important;
	display: inline-block;
	border-bottom: 1px solid #d9d9d9 !important;
}

</style>
<script src="/js/jquery-3.6.1.min.js"></script>
<script type="text/javascript">
$(document).ready(function() {
	var token = $("meta[name='_csrf']").attr("content");
	var header = $("meta[name='_csrf_header']").attr("content");
	let i = 0;
	
	//창 시작시 demoDelete 실행
 	let empNo = $("#empNo").val();
	console.log("empNo : " + empNo);
	$.ajax({
        url: "demoDeleteAll",
        beforeSend:function(xhr){
	  		xhr.setRequestHeader(header,token);  
    	  },
    	 type : "post",
        data:{"empNo" : empNo },
        success:function(res){
        	console.log("DB 삭제 완")
        }
	})
	
	//할일 추가 버튼
	$("#addTodo").on("click", e=>{
		let cntn = $("#todoAdd").val(); //할일
		console.log(cntn);
		i++
		if(cntn == ""){
			alert("할 일을 입력해주세요")
		}else{
			//todo 추가
			$.ajax({
		         url: "demoInsert",
		         beforeSend:function(xhr){
		 	  		xhr.setRequestHeader(header,token);  
		     	  },
		     	 type : "post",
		         data:{"cntn" : cntn , "empNo" : empNo},
		         success:function(res){
		        	 console.log(res);
		        	let str = "<tr><td name='no' class='no' style='display: none'>"+ res.no +"</td>";
		     		str += "<td class='cntn'>"+res.cntn+"</td><td><button name='remove' type='button' class='btn btn-outline-danger btn-sm' href='javascript:void(0);' style='right: auto;'>";
		     		str += "<i class='bi bi-x-lg'></i></button> </td> </tr>";
		        	
		     		$("#tbd").append(str);
		         }
			})
		}
	})
	
	//todo 삭제버튼 클릭 시 
	$("#tbd").on("click","[name='remove']", e=>{
		console.log("test")
		let no = e.target.closest('tr').firstChild.innerText;
		console.log(no);
		
		//todo 삭제
		$.ajax({
			url: "demoDelete",
			beforeSend:function(xhr){
				xhr.setRequestHeader(header,token);  
			},
			type : "post",
			data:{"no" : no },
			success:function(res){
				console.log(res);
				e.target.closest('tr').remove();
			}
		})
	})
});

function save(){
	let todo = document.querySelectorAll("tr");
	console.log(todo);
	let ttl = document.querySelector("#ttl");
	console.log(ttl);
	let empNo = document.querySelector("#empNo");
	let wrtr = document.querySelector("#nm");
	let ttl = document.querySelector("#ttl");
	if(todo == null){
		console.log("할일 목록 없음");
		alert("할 일을 등록해주세요");
	}else{
		console.log("할일 있음");
		console.log(todo.length);
		//$("#todoFrm").submit();
/* 		$.ajax({
	         url: "todoInsert",
	         beforeSend:function(xhr){
	 	  		xhr.setRequestHeader(header,token);  
	     	  },
	     	 type : "post",
	         data:{"ttl" : ttl , "wrtr" : wrtr , "empNo" : empNo, "prjNo" : "123"},
	         success:function(res){
	        	 console.log(res);
	        	 console.log("todoInsert 성공")
	        	 for(r= 0; r <= todo.length; r++){
	     			let no = todo[r].childNodes[0].innerText
	     			console.log(no);
	     			let cntn = todo[r].childNodes[1].innerText
	     			console.log(cntn)
	     			$.ajax({
	     	         url: "detailInsert",
	     	         beforeSend:function(xhr){
	     	 	  		xhr.setRequestHeader(header,token);  
	     	     	  },
	     	     	 type : "post",
	     	         data:{"cntn" : cntn , "postNo" : res.postNo },
	     	         success:function(res){
	     	        	 console.log(res);
	     	        	 console.log("detailInert 성공")
	     	        	 consol.log(cntn)
	     	         }
	     		})
	     			
	     		}
	        	 
	         }
		}) */
		
		
		
		
		

	}
}
</script>
</head>
<body>
<main layout:fragment="content">
	<div class="card">
		<div class="card-body">
			<h5 class="card-title">PROJECT</h5>
			<!-- Default Tabs -->
			<div style="padding: 20px;">
				<div>
					<ul class="nav nav-tabs d-flex" id="myTabjustified" role="tablist">
						<li class="nav-item flex-fill" role="presentation">
							<button class="nav-link w-100" id="contact-tab"
								data-bs-toggle="tab" data-bs-target="#contact-justified"
								type="button" role="tab" aria-controls="contact"
								aria-selected="false">할일</button>
						</li>
					</ul>
				</div>
				<div class="tab-content pt-2" id="myTabjustifiedContent">
					<div class="tab-content pt-2" id="myTabjustifiedContent">
				
						<!-- 할일 -->
						<div class="tab-pane fade" id="contact-justified" role="tabpanel">
							<div class="row mb-3">
								<!-- todo insert -->
								<form id="todoFrm" action="todoInsert" method="post">
									<div class="col-sm-10" style="width: 80%">
										<input type="text" class="form-control none" style="border-bottom:1px solid blue;"
											id="ttl" name="ttl" placeholder="제목을 입력하세요.">
									</div>
									<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
									<input type="hidden" id="empNo" name="empNo" th:value="${session.empNo}">
									<input type="hidden" id="wrtr" name="wrtr" th:value="${session.nm}">
									<input type="hidden" id="prjNo" name="prjNo" value="111">
								</form>
							</div> <br>
							
							<!-- todo 상세 Insert -->
								<div class="col-sm-10">
									<div class="input-group mb-3">
										<input type="text" id="todoAdd" name="cntn" class="form-control" placeholder="할 일 입력" 
										aria-label="Recipient's username" aria-describedby="basic-addon2">
										<button id="addTodo" type="button" class="btn btn-outline-secondary" style="right: auto;">
											<i class="bi bi-plus-lg"></i>
										</button>
									</div>
									<hr>
									<form id="addFrm" action="detailInsert" method="post">
										<div>
											<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
											<input type="hidden" id="empNo" name="empNo" th:value="${session.empNo}">
											<table class="table table-borderless">
												<tbody id="tbd">
												</tbody>
											</table>
										</div>
									</form>
								</div>
							<br>
							<div class="col-md-8 col-lg-9">
				               <button id="btn" class="btn btn-primary" type="button">등록</button>
				               <button id="btn" class="btn btn-primary" type="button" onclick="save()">테스트</button>
							</div>
						<!-- 할일 -->
						</div>
					<!-- End Default Tabs -->
					</div>
				</div>
			</div>
		</div>
	</div>
</main>
</body>
</html>